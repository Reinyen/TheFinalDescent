<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Final Descent - Refactored</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/MotionPathPlugin.min.js"></script>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden">
        <div id="loading-bar-container">
            <div id="loading-bar-fill"></div>
            <div id="loading-percentage">0%</div>
        </div>
        <div id="loading-text">The Descent awaits...</div>
    </div>

    <!-- Background Container -->
    <div id="fullscreen-bg-container">
        <div id="void-bg"></div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen">
        <div id="ember-container"></div>
        <h1 class="title glitch-text" data-text="The Final Descent">The Final Descent</h1>
        <button id="start-game-btn" class="spectral-btn">Begin the Descent</button>
        
        <!-- Debug/Development Controls -->
        <div id="dev-controls" style="position: absolute; bottom: 20px; left: 20px; display: none;">
            <button id="load-save-btn" class="spectral-btn debug">Load Save</button>
            <button id="dev-mode-btn" class="spectral-btn debug">Dev Mode</button>
        </div>
    </div>

    <!-- Roster Screen -->
    <div id="roster-screen" class="hidden">
        <div class="roster-container">
            <h1 class="roster-title glitch-text" data-text="Assemble Your Party">Assemble Your Party</h1>
            <p class="roster-subtitle">You have <span id="roster-reroll-counter">3</span> rerolls remaining.</p>
            <div class="roster-main-content">
                <div id="roster-party-selection" class="roster-party-selection"></div>
            </div>
            <div class="roster-controls">
                <button id="roster-reroll-btn" class="spectral-btn">Reroll Party</button>
                <button id="proceed-to-dungeon-btn" class="spectral-btn">Begin Exploration</button>
                <button id="save-game-btn" class="spectral-btn debug">Save Game</button>
            </div>
        </div>
    </div>

    <!-- Dungeon Screen -->
    <div id="dungeon-screen" class="hidden">
        <div class="top-bar">Dungeon Info Placeholder</div>
        <div class="main-content">
            <div id="dungeon-party-display" class="left-panel"></div>
            <div class="center-panel">
                <div class="map-container" id="mapContainer">
                    <svg id="mapLines"></svg>
                    <div id="tooltip" class="tooltip">Placeholder text for this node type.</div>
                </div>
            </div>
            <div class="right-panel">
                <!-- Debug controls will be added here dynamically in dev mode -->
                <div id="dungeon-debug-controls"></div>
            </div>
        </div>
        <div class="bottom-bar">
            <div id="chat-container">
                <input type="text" id="chat-input" placeholder="Select a character to speak...">
                <button id="chat-send-btn">Send</button>
            </div>
            <div id="dungeon-status">
                <span id="current-floor">Floor 1</span>
                <span id="party-status">Party Ready</span>
            </div>
        </div>
    </div>

    <!-- Combat Screen -->
    <div id="game-container" class="hidden">
        <div id="combat-arena" class="layout">
            <div id="game-title" class="game-title">
                <div id="combat-stats-display">
                    <div>Level: <span id="party-level-display">1</span></div>
                    <div>Turn: <span id="turn-counter-display">1</span></div>
                </div>
                <span>The Final Descent</span>
            </div>

            <div id="top-bar" class="top-bar">
                <div id="party-status-summary" class="status-summary-container"></div>
                <div id="stamina-container"></div>
                <div id="enemy-status-summary" class="status-summary-container"></div>
            </div>

            <div id="party-section" class="ui-panel party-panel"><h3>Party</h3></div>
            
            <div class="animation-panel">
                <div id="void-container">
                    <div id="void-spin"></div>
                    <div id="void-eye"></div>
                    <div id="star-particle-container"></div>
                </div>
            </div>
            
            <div id="enemy-section" class="ui-panel enemy-panel"><h3>Enemies</h3></div>
            
            <div class="ui-panel items-panel">
                <h3>Special Items</h3>
                <div id="items-list">
                    <p>Empty Vial</p>
                    <p>Iron Key</p>
                    <p>Nullstone Charm</p>
                </div>
            </div>
            
            <div id="action-pool-container" class="action-panel"></div>
            
            <div id="controls-panel" class="controls-panel">
                <button id="execute-turn-btn" class="control-btn spectral-btn" disabled>Execute Turn</button>
                <button id="clear-selections-btn" class="control-btn spectral-btn">Clear</button>
                <button id="auto-win-btn" class="control-btn spectral-btn debug">Auto Win</button>
            </div>
            
            <div id="combat-log-container" class="ui-panel log-panel">
                <h3>Combat Log</h3>
                <div id="combat-log"></div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="hidden">
        <h2 id="game-over-message" class="glitch-text" data-text="The Descent Ends">The Descent Ends</h2>
        <div id="game-over-stats">
            <p>Final Floor: <span id="final-floor">1</span></p>
            <p>Score: <span id="final-score">0</span></p>
            <p>Time Played: <span id="time-played">0:00</span></p>
        </div>
        <div class="game-over-controls">
            <button id="restart-game-btn" class="control-btn spectral-btn">Play Again</button>
            <button id="return-to-menu-btn" class="control-btn spectral-btn">Main Menu</button>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="hidden">
        <div id="modal-overlay"></div>
        <div id="modal-container">
            <h2 id="modal-title">Event Title</h2>
            <div id="modal-content"></div>
            <div id="modal-buttons"></div>
        </div>
    </div>

    <!-- Milestone Screen -->
    <div id="milestone-screen" class="hidden">
        <div id="milestone-starfield-bg"></div>

        <header id="top-section">Milestone Reached</header>

        <div class="frame" id="character-frame">
            <img src="https://placehold.co/150x150/000000/FFFFFF/png?text=Char" alt="Character Portrait" class="char-portrait">
            <div class="info-block">
                <p><span class="stat-name">Health:</span> <span id="char-hp">N/A</span></p>
                <p><span class="stat-name">Path:</span> <span id="char-path">N/A</span></p>
                <p><span class="stat-name">CON:</span> <span id="char-con">N/A</span></p>
                <p><span class="stat-name">SPD:</span> <span id="char-spd">N/A</span></p>
                <p><span class="stat-name">Passives:</span> <span id="char-passives">0</span></p>
                <button id="abilities-button">Abilities</button>
            </div>
        </div>

        <div id="center-frame"><p>[Awaiting Your Choice]</p></div>
        <div id="reward-info"><p>Hover over a reward to see its details.</p></div>
        <div id="reward-section"></div>

        <button id="confirm-button" disabled>Confirm Choice</button>

        <div id="abilities-modal">
            <div id="abilities-content">
                <h2 id="abilities-char-name">Character Abilities</h2>
                <div class="ability-grid" id="abilities-grid"></div>
                <button id="close-abilities">Close</button>
            </div>
        </div>
    </div>

    <!-- Performance Monitor (dev mode only) -->
    <div id="performance-monitor" style="display: none;">
        <div id="perf-display">
            <div>Memory: <span id="memory-usage">--</span></div>
            <div>Resources: <span id="resource-count">--</span></div>
            <div>FPS: <span id="fps-counter">--</span></div>
        </div>
    </div>

    <!-- Error Fallback -->
    <div id="error-fallback" class="hidden">
        <div class="error-container">
            <h1>Game Initialization Failed</h1>
            <p>The game failed to start properly. Please try refreshing the page.</p>
            <button onclick="window.location.reload()">Reload Game</button>
        </div>
    </div>

    <!-- Module Loading -->
    <script type="module">
        // Import the main bootstrap
        import { initializeGame, gameController } from './main/bootstrap.js';
        
        // Development mode detection
        const isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.search.includes('dev=true');
        
        if (isDevelopment) {
            // Show development controls
            document.getElementById('dev-controls').style.display = 'block';
            document.getElementById('performance-monitor').style.display = 'block';
            
            // Enable debug buttons
            document.querySelectorAll('.debug').forEach(btn => {
                btn.style.display = 'inline-block';
            });
        }
        
        // Initialize the game
        try {
            await initializeGame();
            console.log('Game initialized successfully');
        } catch (error) {
            console.error('Failed to initialize game:', error);
            
            // Show error fallback
            document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById('error-fallback').classList.remove('hidden');
        }
        
        // Expose game controller globally for debugging
        window.game = gameController;
        
        console.log('The Final Descent - Refactored Architecture Loaded');
    </script>

    <!-- Fallback for browsers without module support -->
    <script nomodule>
        document.body.innerHTML = `
            <div style="
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #000; color: #fff; display: flex; justify-content: center;
                align-items: center; flex-direction: column; font-family: Arial, sans-serif;
            ">
                <h1>Browser Not Supported</h1>
                <p>This game requires a modern browser with ES6 module support.</p>
                <p>Please update your browser or try a different one.</p>
            </div>
        `;
    </script>

</body>
</html>